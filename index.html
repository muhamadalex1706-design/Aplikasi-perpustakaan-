<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perpustakaan Buku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        /* Animasi untuk kartu buku dan modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .book-card-enter, .user-row-enter, .history-row-enter {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .modal-content-zoom {
            animation: zoomIn 0.3s ease-out forwards;
        }
        .book-cover {
            aspect-ratio: 2 / 3;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Halaman Login -->
    <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg modal-content-zoom">
            <h2 class="text-3xl font-bold text-center text-gray-900">Login Sistem Perpustakaan</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input id="username" name="username" type="text" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="admin">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="admin123">
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center hidden">Username atau password salah!</p>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Masuk
                    </button>
                </div>
                 <div class="text-center text-sm text-gray-500">
                    <p>Login sebagai <span class="font-bold">Pengunjung</span>? <a href="#" id="guest-login" class="font-medium text-green-600 hover:text-green-500">Klik di sini</a></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Halaman Perpustakaan -->
    <div id="library-page" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-green-600">Perpustakaan Digital</h1>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <p id="welcome-message" class="text-gray-600 hidden sm:block"></p>
                    <button id="my-history-btn" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2"><i class="fas fa-history"></i><span class="hidden sm:inline">Riwayat Saya</span></button>
                    <button id="add-book-btn" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2"><i class="fas fa-plus-circle"></i><span class="hidden sm:inline">Tambah Buku</span></button>
                    <button id="manage-users-btn" class="hidden bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition duration-300 flex items-center gap-2"><i class="fas fa-users-cog"></i><span class="hidden sm:inline">Kelola User</span></button>
                    <button id="manage-history-btn" class="hidden bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition duration-300 flex items-center gap-2"><i class="fas fa-clipboard-list"></i><span class="hidden sm:inline">Kelola Riwayat</span></button>
                    <button id="logout-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-300">Keluar</button>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Search Bar -->
            <div class="mb-8">
                <div class="relative">
                    <input type="text" id="search-bar" class="w-full p-4 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500" placeholder="Cari buku berdasarkan judul atau penulis...">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
            </div>

            <!-- Book List -->
            <div id="book-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- Book cards will be inserted here by JavaScript -->
            </div>
            <p id="no-results" class="text-center text-gray-500 mt-8 hidden">Tidak ada buku yang ditemukan.</p>
        </main>
    </div>
    
    <!-- Halaman Kelola User -->
    <div id="user-management-page" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
         <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Kelola Pengguna</h2>
            <button id="back-to-library-btn-from-user" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2"><i class="fas fa-arrow-left"></i> Kembali ke Perpustakaan</button>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h3 class="text-xl font-bold mb-4">Tambah Pengguna Baru</h3>
            <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="new-username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="new-username" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="new-password" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="new-role" class="block text-sm font-medium text-gray-700">Role</label>
                    <select id="new-role" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="w-full md:w-auto justify-center px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Tambah User</button>
            </form>
        </div>
        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
             <table class="w-full text-left">
                <thead class="bg-gray-50 border-b-2 border-gray-200">
                    <tr>
                        <th class="p-4">Username</th>
                        <th class="p-4">Role</th>
                        <th class="p-4 text-right">Aksi</th>
                    </tr>
                </thead>
                <tbody id="user-table-body"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Halaman Riwayat Peminjaman (Admin View) -->
    <div id="history-management-page" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Riwayat Peminjaman Buku</h2>
            <button id="back-to-library-btn-from-history" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2"><i class="fas fa-arrow-left"></i> Kembali ke Perpustakaan</button>
        </div>
        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
             <table class="w-full text-left">
                <thead class="bg-gray-50 border-b-2 border-gray-200">
                    <tr>
                        <th class="p-4">Judul Buku</th>
                        <th class="p-4">Peminjam</th>
                        <th class="p-4">Tanggal Pinjam</th>
                        <th class="p-4">Tanggal Kembali</th>
                        <th class="p-4">Status</th>
                    </tr>
                </thead>
                <tbody id="all-history-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Halaman Riwayat Peminjaman Saya (User View) -->
     <div id="my-history-page" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Riwayat Peminjaman Saya</h2>
            <button id="back-to-library-btn-from-my-history" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2"><i class="fas fa-arrow-left"></i> Kembali ke Perpustakaan</button>
        </div>
        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
             <table class="w-full text-left">
                <thead class="bg-gray-50 border-b-2 border-gray-200">
                    <tr>
                        <th class="p-4">Judul Buku</th>
                        <th class="p-4">Tanggal Pinjam</th>
                        <th class="p-4">Tanggal Kembali</th>
                        <th class="p-4">Status</th>
                    </tr>
                </thead>
                <tbody id="my-history-table-body"></tbody>
            </table>
        </div>
    </div>


    <!-- Modal for Adding/Editing Book -->
    <div id="book-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-lg p-6 rounded-xl shadow-2xl modal-content-zoom">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Tambah Buku Baru</h2>
            <form id="book-form">
                <input type="hidden" id="book-id">
                <div class="space-y-4">
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700">Judul</label>
                        <input type="text" id="title" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="author" class="block text-sm font-medium text-gray-700">Penulis</label>
                        <input type="text" id="author" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-700">Tahun Terbit</label>
                        <input type="number" id="year" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="cover-url" class="block text-sm font-medium text-gray-700">URL Gambar Sampul</label>
                        <input type="url" id="cover-url" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for Book Details -->
    <div id="details-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-3xl p-6 rounded-xl shadow-2xl modal-content-zoom flex flex-col md:flex-row gap-6">
            <img id="details-cover" src="" alt="Book Cover" class="w-full md:w-1/3 rounded-lg shadow-md book-cover">
            <div class="flex-1 flex flex-col">
                <h2 id="details-title" class="text-3xl font-bold mb-2"></h2>
                <p id="details-author" class="text-xl text-gray-600 mb-4"></p>
                <p id="details-year" class="text-md text-gray-500 mb-6"></p>
                <div class="mt-auto flex justify-between items-center">
                    <div id="borrow-container">
                         <!-- borrow-btn or return-btn will be inserted here -->
                    </div>
                     <button type="button" id="close-details-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl modal-content-zoom text-center">
            <div id="alert-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                 <i id="alert-icon" class="fas fa-check-circle text-2xl text-green-600"></i>
            </div>
            <h3 id="alert-title" class="text-lg font-medium text-gray-900 mb-2">Pemberitahuan</h3>
            <p id="alert-message" class="text-sm text-gray-600 mb-6"></p>
            <button id="close-alert-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Tutup</button>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl modal-content-zoom text-center">
             <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                 <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Konfirmasi Aksi</h3>
            <p id="confirmation-message" class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-action-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Batal</button>
                <button id="confirm-action-btn" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Hapus</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const loginPage = document.getElementById('login-page');
            const libraryPage = document.getElementById('library-page');
            const userManagementPage = document.getElementById('user-management-page');
            const historyManagementPage = document.getElementById('history-management-page');
            const myHistoryPage = document.getElementById('my-history-page');

            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const guestLoginBtn = document.getElementById('guest-login');
            const logoutBtn = document.getElementById('logout-btn');
            const addBookBtn = document.getElementById('add-book-btn');
            const manageUsersBtn = document.getElementById('manage-users-btn');
            const manageHistoryBtn = document.getElementById('manage-history-btn');
            const myHistoryBtn = document.getElementById('my-history-btn');
            const welcomeMessage = document.getElementById('welcome-message');
            const bookListContainer = document.getElementById('book-list');
            const searchBar = document.getElementById('search-bar');
            const noResults = document.getElementById('no-results');

            document.getElementById('back-to-library-btn-from-user').addEventListener('click', showLibraryPage);
            document.getElementById('back-to-library-btn-from-history').addEventListener('click', showLibraryPage);
            document.getElementById('back-to-library-btn-from-my-history').addEventListener('click', showLibraryPage);
            
            // User Management DOM
            const addUserForm = document.getElementById('add-user-form');
            const userTableBody = document.getElementById('user-table-body');
            const newUsernameInput = document.getElementById('new-username');
            const newPasswordInput = document.getElementById('new-password');
            const newRoleInput = document.getElementById('new-role');

            // History Management DOM
            const allHistoryTableBody = document.getElementById('all-history-table-body');
            const myHistoryTableBody = document.getElementById('my-history-table-body');

            // Book Modal Elements
            const bookModal = document.getElementById('book-modal');
            const bookForm = document.getElementById('book-form');
            const modalTitle = document.getElementById('modal-title');
            const cancelBtn = document.getElementById('cancel-btn');
            const bookIdInput = document.getElementById('book-id');
            const titleInput = document.getElementById('title');
            const authorInput = document.getElementById('author');
            const yearInput = document.getElementById('year');
            const coverUrlInput = document.getElementById('cover-url');
            
            // Details Modal Elements
            const detailsModal = document.getElementById('details-modal');
            const closeDetailsBtn = document.getElementById('close-details-btn');
            const detailsCover = document.getElementById('details-cover');
            const detailsTitle = document.getElementById('details-title');
            const detailsAuthor = document.getElementById('details-author');
            const detailsYear = document.getElementById('details-year');
            const borrowContainer = document.getElementById('borrow-container');
            
            // Custom Modals Elements
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertIconContainer = document.getElementById('alert-icon-container');
            const alertIcon = document.getElementById('alert-icon');
            const closeAlertBtn = document.getElementById('close-alert-btn');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationMessage = document.getElementById('confirmation-message');
            const cancelActionBtn = document.getElementById('cancel-action-btn');
            const confirmActionBtn = document.getElementById('confirm-action-btn');

            // App State
            let books = [];
            let users = [];
            let borrowingHistory = [];
            let currentUser = null;
            let confirmationCallback = null;

            // --- DATA HANDLING & INITIALIZATION ---
            
            const getInitialBooks = () => [ { id: 1, title: "Laskar Pelangi", author: "Andrea Hirata", year: 2005, cover: "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1585331572l/58128.jpg" }, { id: 2, title: "Bumi Manusia", author: "Pramoedya Ananta Toer", year: 1980, cover: "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1585324317l/409392.jpg" }, { id: 3, title: "Cantik Itu Luka", author: "Eka Kurniawan", year: 2002, cover: "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1425449733l/25018616.jpg" }, { id: 4, title: "Negeri 5 Menara", author: "Ahmad Fuadi", year: 2009, cover: "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1317793019l/6643207.jpg" }, { id: 5, title: "Perahu Kertas", author: "Dee Lestari", year: 2009, cover: "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1585334204l/7818749.jpg" }, { id: 6, title: "Pulang", author: "Tere Liye", year: 2015, cover: "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1446903823l/27814983.jpg" } ];
            const getInitialUsers = () => [ { id: 1, username: 'admin', password: 'admin123', role: 'admin' }, { id: 2, username: 'user', password: 'user123', role: 'user' } ];
            const getInitialHistory = () => [];
            
            function loadData() {
                books = JSON.parse(localStorage.getItem('libraryBooks')) || getInitialBooks();
                users = JSON.parse(localStorage.getItem('libraryUsers')) || getInitialUsers();
                borrowingHistory = JSON.parse(localStorage.getItem('libraryHistory')) || getInitialHistory();
                
                saveBooks();
                saveUsers();
                saveHistory();
            }

            const saveBooks = () => localStorage.setItem('libraryBooks', JSON.stringify(books));
            const saveUsers = () => localStorage.setItem('libraryUsers', JSON.stringify(users));
            const saveHistory = () => localStorage.setItem('libraryHistory', JSON.stringify(borrowingHistory));

            // --- RENDER & UI ---

            function renderBooks(bookArray = books) {
                bookListContainer.innerHTML = '';
                noResults.classList.toggle('hidden', bookArray.length > 0);
                
                bookArray.forEach(book => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 cursor-pointer book-card-enter';
                    const isAdmin = currentUser && currentUser.role === 'admin';
                    
                    card.innerHTML = `
                        <img src="${book.cover}" alt="${book.title}" class="w-full h-auto book-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x600/e2e8f0/4a5568?text=No+Image';">
                        <div class="p-4">
                            <h3 class="font-bold text-md truncate">${book.title}</h3>
                            <p class="text-sm text-gray-600">${book.author}</p>
                        </div>
                        ${isAdmin ? `<div class="px-4 pb-4 flex justify-end gap-2">
                            <button data-id="${book.id}" class="edit-btn text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                            <button data-id="${book.id}" class="delete-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    `;
                    
                    card.addEventListener('click', () => showDetailsModal(book.id));

                    if (isAdmin) {
                        card.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openBookModal(book.id); });
                        card.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteBook(book.id); });
                    }
                    bookListContainer.appendChild(card);
                });
            }

            function renderUsers() {
                userTableBody.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b user-row-enter';
                    const isCurrentUser = currentUser && currentUser.id === user.id;
                    tr.innerHTML = `
                        <td class="p-4 font-medium">${user.username}</td>
                        <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${user.role === 'admin' ? 'bg-teal-100 text-teal-800' : 'bg-gray-100 text-gray-800'}">${user.role}</span></td>
                        <td class="p-4 text-right">
                             <button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700 ${isCurrentUser ? 'opacity-50 cursor-not-allowed' : ''}" ${isCurrentUser ? 'disabled' : ''}><i class="fas fa-trash"></i> Hapus</button>
                        </td>`;
                    if (!isCurrentUser) {
                        tr.querySelector('.delete-user-btn').addEventListener('click', () => deleteUser(user.id));
                    }
                    userTableBody.appendChild(tr);
                });
            }
            
            const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('id-ID') : '-';

            function renderAllHistory() {
                allHistoryTableBody.innerHTML = '';
                borrowingHistory.slice().reverse().forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b history-row-enter';
                    const statusClass = entry.returnDate ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const statusText = entry.returnDate ? 'Dikembalikan' : 'Dipinjam';
                    tr.innerHTML = `
                        <td class="p-4 font-medium">${entry.bookTitle}</td>
                        <td class="p-4">${entry.username}</td>
                        <td class="p-4">${formatDate(entry.borrowDate)}</td>
                        <td class="p-4">${formatDate(entry.returnDate)}</td>
                        <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span></td>`;
                    allHistoryTableBody.appendChild(tr);
                });
            }

            function renderMyHistory() {
                myHistoryTableBody.innerHTML = '';
                if (!currentUser) return;
                const myHistory = borrowingHistory.filter(entry => entry.userId === currentUser.id);
                myHistory.slice().reverse().forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b history-row-enter';
                    const statusClass = entry.returnDate ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const statusText = entry.returnDate ? 'Dikembalikan' : 'Dipinjam';
                    tr.innerHTML = `
                        <td class="p-4 font-medium">${entry.bookTitle}</td>
                        <td class="p-4">${formatDate(entry.borrowDate)}</td>
                        <td class="p-4">${formatDate(entry.returnDate)}</td>
                        <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span></td>`;
                    myHistoryTableBody.appendChild(tr);
                });
            }


            function updateUIForUser() {
                const isAdmin = currentUser && currentUser.role === 'admin';
                const isUser = currentUser && currentUser.role === 'user';
                const isGuest = !currentUser || currentUser.role === 'guest';

                addBookBtn.classList.toggle('hidden', !isAdmin);
                manageUsersBtn.classList.toggle('hidden', !isAdmin);
                manageHistoryBtn.classList.toggle('hidden', !isAdmin);
                myHistoryBtn.classList.toggle('hidden', !isUser && !isAdmin);

                if (isGuest) {
                    welcomeMessage.textContent = 'Selamat datang, Pengunjung!';
                } else {
                    welcomeMessage.textContent = `Selamat datang, ${currentUser.username}!`;
                }
                
                welcomeMessage.classList.remove('hidden');
                loginPage.classList.add('hidden');
                showLibraryPage();
                renderBooks();
            }

            // --- PAGE NAVIGATION ---
            function showLibraryPage() {
                libraryPage.classList.remove('hidden');
                userManagementPage.classList.add('hidden');
                historyManagementPage.classList.add('hidden');
                myHistoryPage.classList.add('hidden');
                searchBar.value = '';
                renderBooks();
            }

            function showUserManagementPage() {
                libraryPage.classList.add('hidden');
                userManagementPage.classList.remove('hidden');
                renderUsers();
            }

            function showHistoryManagementPage() {
                libraryPage.classList.add('hidden');
                historyManagementPage.classList.remove('hidden');
                renderAllHistory();
            }

            function showMyHistoryPage() {
                libraryPage.classList.add('hidden');
                myHistoryPage.classList.remove('hidden');
                renderMyHistory();
            }


            // --- LOGIN & LOGOUT ---

            function handleLogin(event) {
                event.preventDefault();
                const username = loginForm.username.value;
                const password = loginForm.password.value;
                const foundUser = users.find(user => user.username === username && user.password === password);
                if (foundUser) {
                    currentUser = foundUser;
                    sessionStorage.setItem('libraryUser', JSON.stringify(currentUser));
                    updateUIForUser();
                } else {
                    loginError.classList.remove('hidden');
                }
            }

            function handleGuestLogin(e) {
                e.preventDefault();
                currentUser = { role: 'guest' };
                sessionStorage.setItem('libraryUser', JSON.stringify(currentUser));
                updateUIForUser();
            }

            function handleLogout() {
                currentUser = null;
                sessionStorage.removeItem('libraryUser');
                [libraryPage, userManagementPage, historyManagementPage, myHistoryPage].forEach(p => p.classList.add('hidden'));
                loginPage.classList.remove('hidden');
                loginForm.reset();
                loginError.classList.add('hidden');
            }
            
            function checkSession() {
                const user = sessionStorage.getItem('libraryUser');
                if (user) {
                    currentUser = JSON.parse(user);
                    updateUIForUser();
                }
            }

            // --- BOOK CRUD ---
            
            const addBook = (title, author, year, cover) => { books.push({ id: Date.now(), title, author, year: parseInt(year), cover }); saveBooks(); renderBooks(); };
            
            function updateBook(id, title, author, year, cover) {
                const bookIndex = books.findIndex(b => b.id === id);
                if (bookIndex > -1) {
                    books[bookIndex] = { id, title, author, year: parseInt(year), cover };
                    saveBooks();
                    renderBooks();
                }
            }

            function deleteBook(id) {
                showConfirmation('Apakah Anda yakin ingin menghapus buku ini?', () => {
                    books = books.filter(b => b.id !== id);
                    saveBooks();
                    renderBooks();
                    showAlert('Buku berhasil dihapus.');
                });
            }

            // --- USER MANAGEMENT ---
            function handleAddUser(e) {
                e.preventDefault();
                const username = newUsernameInput.value.trim();
                const password = newPasswordInput.value.trim();
                const role = newRoleInput.value;
                if(username && password) {
                    if (users.some(u => u.username === username)) {
                        showAlert('Username sudah ada.', 'error');
                        return;
                    }
                    users.push({ id: Date.now(), username, password, role });
                    saveUsers();
                    renderUsers();
                    addUserForm.reset();
                    showAlert('User berhasil ditambahkan.');
                } else {
                    showAlert('Username dan password tidak boleh kosong.', 'error');
                }
            }

            function deleteUser(id) {
                 showConfirmation('Apakah Anda yakin ingin menghapus pengguna ini?', () => {
                    users = users.filter(u => u.id !== id);
                    saveUsers();
                    renderUsers();
                    showAlert('User berhasil dihapus.');
                });
            }
            
            // --- BORROWING ---
            function borrowBook(bookId) {
                const book = books.find(b => b.id === bookId);
                if (!book || !currentUser || currentUser.role === 'guest') return;

                const alreadyBorrowed = borrowingHistory.find(entry => entry.bookId === bookId && entry.userId === currentUser.id && !entry.returnDate);
                if (alreadyBorrowed) {
                    showAlert('Anda sudah meminjam buku ini.', 'error');
                    return;
                }

                borrowingHistory.push({
                    id: Date.now(),
                    bookId: book.id,
                    bookTitle: book.title,
                    userId: currentUser.id,
                    username: currentUser.username,
                    borrowDate: new Date().toISOString(),
                    returnDate: null
                });
                saveHistory();
                showAlert(`Buku "${book.title}" berhasil dipinjam.`);
                showDetailsModal(bookId); // Refresh modal
            }

            function returnBook(historyId) {
                const historyEntry = borrowingHistory.find(entry => entry.id === historyId);
                if(historyEntry) {
                    historyEntry.returnDate = new Date().toISOString();
                    saveHistory();
                    showAlert(`Buku "${historyEntry.bookTitle}" berhasil dikembalikan.`);
                    showDetailsModal(historyEntry.bookId); // Refresh modal
                }
            }

            // --- MODALS ---
            function openBookModal(id = null) {
                bookForm.reset();
                if (id) {
                    const book = books.find(b => b.id === id);
                    modalTitle.textContent = 'Edit Buku';
                    bookIdInput.value = book.id;
                    titleInput.value = book.title;
                    authorInput.value = book.author;
                    yearInput.value = book.year;
                    coverUrlInput.value = book.cover;
                } else {
                    modalTitle.textContent = 'Tambah Buku Baru';
                    bookIdInput.value = '';
                }
                bookModal.classList.remove('hidden');
                bookModal.classList.add('flex');
            }

            function closeBookModal() {
                bookModal.classList.add('hidden');
                bookModal.classList.remove('flex');
            }
            
            function handleBookFormSubmit(e) {
                e.preventDefault();
                const id = parseInt(bookIdInput.value);
                const title = titleInput.value;
                const author = authorInput.value;
                const year = yearInput.value;
                const cover = coverUrlInput.value;
                if(id) {
                    updateBook(id, title, author, year, cover);
                    showAlert('Buku berhasil diperbarui.');
                } else {
                    addBook(title, author, year, cover);
                    showAlert('Buku berhasil ditambahkan.');
                }
                closeBookModal();
            }

            function showDetailsModal(id) {
                const book = books.find(b => b.id === id);
                if (!book) return;

                detailsCover.src = book.cover;
                detailsCover.alt = book.title;
                detailsTitle.textContent = book.title;
                detailsAuthor.textContent = `oleh ${book.author}`;
                detailsYear.textContent = `Tahun terbit: ${book.year}`;
                
                borrowContainer.innerHTML = '';
                const isUserOrAdmin = currentUser && (currentUser.role === 'user' || currentUser.role === 'admin');
                
                if (isUserOrAdmin) {
                    const borrowedEntry = borrowingHistory.find(entry => entry.bookId === id && entry.userId === currentUser.id && !entry.returnDate);

                    if (borrowedEntry) {
                        const returnBtn = document.createElement('button');
                        returnBtn.id = 'return-btn';
                        returnBtn.className = 'px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600';
                        returnBtn.textContent = 'Kembalikan Buku';
                        returnBtn.onclick = () => returnBook(borrowedEntry.id);
                        borrowContainer.appendChild(returnBtn);
                    } else {
                         const borrowBtn = document.createElement('button');
                        borrowBtn.id = 'borrow-btn';
                        borrowBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
                        borrowBtn.textContent = 'Pinjam Buku';
                        borrowBtn.onclick = () => borrowBook(id);
                        borrowContainer.appendChild(borrowBtn);
                    }
                }
                
                detailsModal.classList.remove('hidden');
                detailsModal.classList.add('flex');
            }
            
            function closeDetailsModal() {
                detailsModal.classList.add('hidden');
                detailsModal.classList.remove('flex');
            }

            function showAlert(message, type = 'success') {
                alertMessage.textContent = message;
                alertIconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4'; // Reset classes
                alertIcon.className = 'text-2xl'; // Reset classes

                if (type === 'error') {
                    alertTitle.textContent = 'Error';
                    alertIconContainer.classList.add('bg-red-100');
                    alertIcon.classList.add('fas', 'fa-times-circle', 'text-red-600');
                } else {
                    alertTitle.textContent = 'Sukses';
                    alertIconContainer.classList.add('bg-green-100');
                    alertIcon.classList.add('fas', 'fa-check-circle', 'text-green-600');
                }

                alertModal.classList.remove('hidden');
                alertModal.classList.add('flex');
            }
            
            function showConfirmation(message, onConfirm) {
                confirmationMessage.textContent = message;
                confirmationCallback = onConfirm;
                confirmationModal.classList.remove('hidden');
                confirmationModal.classList.add('flex');
            }

            function closeConfirmation() {
                confirmationModal.classList.add('hidden');
                confirmationModal.classList.remove('flex');
                confirmationCallback = null;
            }

            // --- EVENT LISTENERS ---
            loginForm.addEventListener('submit', handleLogin);
            guestLoginBtn.addEventListener('click', handleGuestLogin);
            logoutBtn.addEventListener('click', handleLogout);

            addBookBtn.addEventListener('click', () => openBookModal());
            cancelBtn.addEventListener('click', closeBookModal);
            bookForm.addEventListener('submit', handleBookFormSubmit);
            
            closeDetailsBtn.addEventListener('click', closeDetailsModal);
            
            closeAlertBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
                alertModal.classList.remove('flex');
            });

            confirmActionBtn.addEventListener('click', () => {
                if(confirmationCallback) {
                    confirmationCallback();
                }
                closeConfirmation();
            });
            cancelActionBtn.addEventListener('click', closeConfirmation);

            searchBar.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredBooks = books.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm)
                );
                renderBooks(filteredBooks);
            });
            
            manageUsersBtn.addEventListener('click', showUserManagementPage);
            addUserForm.addEventListener('submit', handleAddUser);

            manageHistoryBtn.addEventListener('click', showHistoryManagementPage);
            myHistoryBtn.addEventListener('click', showMyHistoryPage);

            // --- INITIALIZATION ---
            loadData();
            checkSession();
        });
    </script>
</body>
</html>
